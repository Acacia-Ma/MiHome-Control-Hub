# 米家设备整合控制系统

一个集成了设备发现、配置和手势控制功能的米家设备控制系统。

## 功能特性

### 🔍 设备发现与配置
- **自动发现米家设备**：通过小米云服务自动发现用户账户下的所有米家设备
- **可视化设备选择**：提供友好的GUI界面选择需要控制的设备
- **一键配置导出**：将设备信息（IP、Token等）自动导出到配置文件
- **多服务器支持**：支持小米全球多个服务器区域（中国、德国、美国等）

### 👋 手势控制
- **实时手势识别**：使用MediaPipe进行高精度手势检测
- **多种手势支持**：
  - 张开手掌：打开所有设备
  - 握拳：关闭所有设备
  - 竖起大拇指：增加亮度
  - 大拇指向下：降低亮度
- **智能防误触**：内置手势冷却机制，避免误操作

### 🎛️ 设备管理
- **统一设备控制**：支持多种米家设备类型（台灯、吸顶灯、Yeelight等）
- **实时状态监控**：显示设备在线状态、亮度、色温等信息
- **批量操作**：支持同时控制多个设备
- **设备分组管理**：按房间或类型对设备进行分组
- **智能状态缓存**：优化设备状态检查，减少网络请求
- **超时控制**：设备连接超时保护，避免界面卡顿
- **手动刷新**：支持按需检查设备在线状态

## 系统架构

```
米家设备整合控制系统
├── 设备发现模块 (xiaomi_device_extractor.py)
│   ├── 小米账户登录
│   ├── 2FA双因子认证
│   ├── 设备列表获取
│   └── Token提取
├── 手势控制模块 (mediapipe_gesture_detector.py)
│   ├── 摄像头管理
│   ├── 手势识别
│   └── 动作映射
├── 设备控制模块 (device_controller.py)
│   ├── 设备连接管理
│   ├── 状态监控
│   └── 控制指令发送
├── 用户界面模块
│   ├── 主控制界面 (integrated_app.py)
│   ├── 设备选择界面 (device_selector_gui.py)
│   └── 设备管理界面 (ui_manager.py)
└── 配置管理模块 (config_manager.py)
    ├── 设备配置
    ├── 摄像头配置
    └── 手势映射配置
```

## 安装与使用

### 环境要求
- Python 3.8+
- 摄像头设备
- 米家设备（支持局域网控制）

### 安装步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd mihome-gesture-control
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

3. **运行程序**
   ```bash
   python main_app.py
   ```
   
   或者使用集成版本：
   ```bash
   python integrated_app.py
   ```

### 使用流程

1. **首次使用 - 设备配置**
   - 点击"发现和配置米家设备"按钮
   - 输入小米账户信息进行登录
   - 完成2FA验证（如需要）
   - 在设备列表中选择需要控制的设备
   - 点击"导出配置"保存设备信息

2. **启动手势控制**
   - 确保已配置设备
   - 点击"启动手势控制"按钮
   - 摄像头窗口将显示实时画面
   - 在摄像头前做出相应手势进行控制

3. **设备管理**
   - 点击"设备管理界面"查看所有设备状态
   - 可以手动控制单个设备
   - 查看设备详细信息和状态

## 支持的设备类型

- **米家台灯系列**
  - 米家台灯
  - 米家台灯Pro
  - 米家充电台灯

- **Yeelight系列**
  - Yeelight智能灯泡
  - Yeelight吸顶灯
  - Yeelight彩光灯带

- **其他照明设备**
  - 米家吸顶灯
  - 米家床头灯
  - 支持miio协议的第三方设备

## 手势说明

| 手势 | 功能 | 说明 |
|------|------|------|
| 🖐️ 张开手掌 | 打开设备 | 打开所有配置的设备 |
| ✊ 握拳 | 关闭设备 | 关闭所有配置的设备 |
| 👍 竖起大拇指 | 增加亮度 | 所有设备亮度+20% |
| 👎 大拇指向下 | 降低亮度 | 所有设备亮度-20% |

## 配置文件说明

### config.yaml
主配置文件，包含设备信息和系统设置：

```yaml
devices:
  客厅台灯:
    type: light
    ip: 192.168.1.100
    token: "your_device_token"
  卧室吸顶灯:
    type: ceiling_light
    ip: 192.168.1.101
    token: "your_device_token"

camera:
  device_id: 0
  width: 640
  height: 480
  fps: 30

gesture:
  cooldown: 2.0
  confidence_threshold: 0.7
```

## 故障排除

### 常见问题

1. **设备发现失败**
   - 检查网络连接
   - 确认小米账户信息正确
   - 尝试切换服务器区域

2. **手势识别不准确**
   - 确保光线充足
   - 调整摄像头角度
   - 保持手势清晰稳定

3. **设备控制失败**
   - 检查设备是否在线
   - 确认设备IP地址正确
   - 验证Token是否有效

### 日志查看
程序运行时会在控制台和界面中显示详细日志，帮助诊断问题。

## 技术特性

- **安全性**：使用RC4加密与小米云服务通信
- **稳定性**：完善的错误处理和重连机制
- **高性能**：智能状态缓存和超时控制，避免界面卡顿
- **扩展性**：模块化设计，易于添加新功能
- **用户友好**：直观的GUI界面和状态反馈
- **资源优化**：后台线程处理，不阻塞用户界面

## 开发说明

### 项目结构
```
├── main_app.py               # 主程序入口（推荐使用）
├── integrated_app.py         # 集成应用程序
├── xiaomi_device_extractor.py # 设备发现和Token提取
├── mediapipe_gesture_detector.py # 手势识别
├── device_controller.py      # 设备控制
├── device_selector_gui.py    # 设备选择界面
├── ui_manager.py            # 设备管理界面
├── config_manager.py        # 配置管理
├── config.yaml             # 主配置文件
├── requirements.txt        # 依赖列表
└── README.md              # 项目说明
```

### 添加新设备类型
1. 在`device_controller.py`中添加设备类型支持
2. 更新配置文件模板
3. 测试设备控制功能

### 添加新手势
1. 在`mediapipe_gesture_detector.py`中定义新手势
2. 在`integrated_app.py`中添加手势处理逻辑
3. 更新手势说明文档

## 许可证

本项目基于MIT许可证开源。

## 贡献

欢迎提交Issue和Pull Request来改进项目！

---

**注意**：使用本系统需要米家设备支持局域网控制功能。部分设备可能需要开启开发者模式或局域网控制选项。